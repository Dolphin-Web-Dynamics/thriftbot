<%= turbo_stream_from @item, "ai_content" %>

<div class="flex justify-between items-start mb-6">
  <div>
    <h1 class="text-2xl font-bold text-gray-900"><%= @item.sku %></h1>
    <p class="text-gray-500"><%= @item.general_title %></p>
  </div>
  <div class="flex gap-2">
    <%= link_to "Edit", edit_item_path(@item), class: "bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200" %>
    <%= button_to "Generate AI Content", generate_ai_content_item_path(@item), method: :post, class: "bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700" %>
    <%= link_to "Add Listing", new_item_listing_path(@item), class: "bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700" %>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Main Info -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Images -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Images</h2>
      <div class="flex flex-wrap gap-4">
        <% if @item.front_image.attached? %>
          <div class="text-center">
            <%= image_tag @item.front_image.variant(resize_to_fill: [200, 200]), class: "w-48 h-48 rounded-lg object-cover" %>
            <p class="text-xs text-gray-500 mt-1">Front</p>
          </div>
        <% end %>
        <% if @item.back_image.attached? %>
          <div class="text-center">
            <%= image_tag @item.back_image.variant(resize_to_fill: [200, 200]), class: "w-48 h-48 rounded-lg object-cover" %>
            <p class="text-xs text-gray-500 mt-1">Back</p>
          </div>
        <% end %>
        <% @item.measurement_images.each do |img| %>
          <div class="text-center">
            <%= image_tag img.variant(resize_to_fill: [200, 200]), class: "w-48 h-48 rounded-lg object-cover" %>
            <p class="text-xs text-gray-500 mt-1">Measurement</p>
          </div>
        <% end %>
        <% @item.tag_images.each do |img| %>
          <div class="text-center">
            <%= image_tag img.variant(resize_to_fill: [200, 200]), class: "w-48 h-48 rounded-lg object-cover" %>
            <p class="text-xs text-gray-500 mt-1">Tag</p>
          </div>
        <% end %>
        <% unless @item.front_image.attached? || @item.back_image.attached? %>
          <p class="text-gray-400 text-sm">No images uploaded yet.</p>
        <% end %>
      </div>
    </div>

    <!-- Details -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Details</h2>
      <dl class="grid grid-cols-2 gap-x-6 gap-y-4">
        <% [
          ["Brand", @item.brand&.name],
          ["Category", [@item.category&.name, @item.subcategory&.name].compact.join(" / ")],
          ["Item Type", @item.item_type],
          ["Size", @item.size],
          ["Model", @item.product_model],
          ["Colors", @item.colors],
          ["Materials", @item.materials],
          ["Condition", @item.condition&.humanize],
          ["Target Gender", @item.target_gender&.humanize],
          ["Fit", @item.fit],
          ["Body Fit", @item.body_fit],
          ["Occasion", @item.occasion],
          ["Weight", @item.weight ? "#{@item.weight} lbs" : nil],
          ["Imperfections", @item.imperfections],
        ].each do |label, value| %>
          <% if value.present? %>
            <div>
              <dt class="text-sm font-medium text-gray-500"><%= label %></dt>
              <dd class="text-sm text-gray-900"><%= value %></dd>
            </div>
          <% end %>
        <% end %>
      </dl>
    </div>

    <!-- AI Generated Content -->
    <%= render "ai_content", item: @item %>

    <% if @item.notes.present? %>
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Notes</h2>
        <p class="text-sm text-gray-700 whitespace-pre-wrap"><%= @item.notes %></p>
      </div>
    <% end %>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <!-- Status & Pricing -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Status & Pricing</h2>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-sm text-gray-500">Status</span>
          <%= status_badge(@item.status) %>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-500">Acquisition Cost</span>
          <span class="text-sm font-medium"><%= currency(@item.acquisition_cost) %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-500">Comp Price</span>
          <span class="text-sm font-medium"><%= currency(@item.comp_price) %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-500">Retail Price</span>
          <span class="text-sm font-medium"><%= currency(@item.retail_price) %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-500">Source</span>
          <span class="text-sm"><%= @item.source&.name || "-" %></span>
        </div>
        <% if @item.listed_with_vendoo? %>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500">Vendoo</span>
            <span class="text-sm text-green-600 font-medium">Listed</span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Listings -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Listings</h2>
        <%= link_to "Add", new_item_listing_path(@item), class: "text-sm text-indigo-600 hover:underline" %>
      </div>
      <% if @listings.any? %>
        <div class="space-y-3">
          <% @listings.each do |listing| %>
            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
              <div>
                <p class="text-sm font-medium"><%= listing.platform.name %></p>
                <%= listing_status_badge(listing.status) %>
              </div>
              <div class="text-right">
                <p class="text-sm font-semibold"><%= currency(listing.asking_price) %></p>
                <div class="flex gap-2 mt-1">
                  <%= link_to "Edit", edit_item_listing_path(@item, listing), class: "text-xs text-indigo-600 hover:underline" %>
                  <% if listing.active? %>
                    <%= button_to "Delist", delist_item_listing_path(@item, listing), method: :patch, class: "text-xs text-red-600 hover:underline" %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-400 text-sm">No listings yet.</p>
      <% end %>
    </div>

    <!-- Sale Info / Record Sale -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Sale</h2>
      <% if @sale %>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-sm text-gray-500">Platform</span>
            <span class="text-sm font-medium"><%= @sale.platform.name %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500">Sold Price</span>
            <span class="text-sm font-medium"><%= currency(@sale.sold_price) %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500">Revenue Received</span>
            <span class="text-sm font-medium text-green-600"><%= currency(@sale.revenue_received) %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500">Profit</span>
            <span class="text-sm font-medium <%= @sale.profit && @sale.profit > 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= @sale.profit ? currency(@sale.profit) : "-" %>
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-500">Date</span>
            <span class="text-sm"><%= @sale.sold_on %></span>
          </div>
        </div>
      <% elsif !@item.sold? %>
        <h3 class="text-sm font-medium text-gray-700 mb-3">Record a Sale</h3>
        <%= form_with url: record_sale_item_path(@item), method: :post, class: "space-y-3" do |f| %>
          <div>
            <%= f.label :platform_id, "Platform", class: "block text-sm text-gray-600" %>
            <%= f.select :platform_id, Platform.active.order(:name).pluck(:name, :id), { prompt: "Select..." }, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" %>
          </div>
          <div>
            <%= f.label :sold_price, "Sold Price", class: "block text-sm text-gray-600" %>
            <%= f.number_field :sold_price, step: 0.01, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" %>
          </div>
          <div>
            <%= f.label :revenue_received, "Revenue Received", class: "block text-sm text-gray-600" %>
            <%= f.number_field :revenue_received, step: 0.01, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" %>
          </div>
          <div>
            <%= f.label :sold_on, "Date", class: "block text-sm text-gray-600" %>
            <%= f.date_field :sold_on, value: Date.current, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" %>
          </div>
          <%= f.submit "Record Sale", class: "w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 cursor-pointer" %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
